2004-06-21  Andrew Cagney  <cagney@gnu.org>

	* i386-tdep.c (i386_gdbarch_init): Move the the dwarf2-frame
	sniffer registration to after the signal trampoline frame sniffer.
	* amd64-tdep.c (amd64_init_abi): Include "dwarf2-frame.h".
	Register the dwarf2-frame sniffer, but after the signal trampoline
	sniffer.
	
Index: gdb-6.8/gdb/amd64-tdep.c
===================================================================
--- gdb-6.8.orig/gdb/amd64-tdep.c	2008-03-04 20:49:39.000000000 +0100
+++ gdb-6.8/gdb/amd64-tdep.c	2008-07-14 10:24:54.000000000 +0200
@@ -34,7 +34,7 @@
 #include "regcache.h"
 #include "regset.h"
 #include "symfile.h"
-
+#include "dwarf2-frame.h"
 #include "gdb_assert.h"
 
 #include "amd64-tdep.h"
@@ -1167,6 +1167,8 @@ amd64_init_abi (struct gdbarch_info info
   set_gdbarch_unwind_dummy_id (gdbarch, amd64_unwind_dummy_id);
 
   frame_unwind_append_sniffer (gdbarch, amd64_sigtramp_frame_sniffer);
+  /* Hook in the DWARF CFI frame unwinder after sigtramp.  */
+  frame_unwind_append_sniffer (gdbarch, dwarf2_frame_sniffer);
   frame_unwind_append_sniffer (gdbarch, amd64_frame_sniffer);
   frame_base_set_default (gdbarch, &amd64_frame_base);
 
Index: gdb-6.8/gdb/i386-tdep.c
===================================================================
--- gdb-6.8.orig/gdb/i386-tdep.c	2008-03-04 20:49:39.000000000 +0100
+++ gdb-6.8/gdb/i386-tdep.c	2008-07-14 10:24:54.000000000 +0200
@@ -2480,15 +2480,14 @@ i386_gdbarch_init (struct gdbarch_info i
   /* Helper for function argument information.  */
   set_gdbarch_fetch_pointer_argument (gdbarch, i386_fetch_pointer_argument);
 
-  /* Hook in the DWARF CFI frame unwinder.  */
-  frame_unwind_append_sniffer (gdbarch, dwarf2_frame_sniffer);
-
   frame_base_set_default (gdbarch, &i386_frame_base);
 
   /* Hook in ABI-specific overrides, if they have been registered.  */
   gdbarch_init_osabi (info, gdbarch);
 
   frame_unwind_append_sniffer (gdbarch, i386_sigtramp_frame_sniffer);
+  /* Hook in the DWARF CFI frame unwinder after sigtramp.  */
+  frame_unwind_append_sniffer (gdbarch, dwarf2_frame_sniffer);
   frame_unwind_append_sniffer (gdbarch, i386_frame_sniffer);
 
   /* If we have a register mapping, enable the generic core file
